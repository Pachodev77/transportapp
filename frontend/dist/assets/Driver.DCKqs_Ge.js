import{u as Q,A as X,B as Y,j as e,C as ee,t as b,x as R,c as V,n as se,D as ae,m as te,E as T,G as re,H as ne}from"./index.CX4817qL.js";import{b as ie,r as i}from"./react.C2-qyGTQ.js";import{M as le,T as oe,b as S,L as I,P as k,d as ce}from"./leaflet.DC9QlCQY.js";const A=new I.Icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),de=new I.Icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",iconRetinaUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function me({onSelect:l}){const j=ce();return i.useEffect(()=>{if(!j)return;const m=h=>{l(h.latlng)};return j.on("click",m),()=>{j.off("click",m)}},[j,l]),null}function ge(){const{currentUser:l,logout:j}=Q();ie();const[m,h]=i.useState("available"),q=()=>e.jsxs("div",{className:"flex border-b border-gray-200 mb-4",children:[e.jsx("button",{className:`py-2 px-4 font-medium ${P?"text-gray-500 hover:text-gray-700":"text-blue-600 border-b-2 border-blue-600"}`,onClick:()=>U(!1),children:"Viajes Activos"}),e.jsx("button",{className:`py-2 px-4 font-medium ${P?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"}`,onClick:()=>U(!0),children:"Historial"})]}),[D,B]=i.useState([]),[y,N]=i.useState([]),[E,F]=i.useState([]),[P,U]=i.useState(!1),[p,g]=i.useState(!1),[o,$]=i.useState(null),[c,O]=i.useState(null),[d,L]=i.useState({departureTime:"",availableSeats:1,price:0,carModel:"",carPlate:"",estimatedDuration:""}),[ue,W]=i.useState(null),[r,w]=i.useState(null),u=i.useRef(),J=i.useRef(!1),C=i.useRef(null),v=(s,t,a=15)=>{if(!u.current)return console.log("Map reference not available, storing pending center:",{lat:s,lng:t}),C.current={lat:s,lng:t,zoom:a},!1;try{return console.log("Centering map to:",{lat:s,lng:t,zoom:a}),u.current.setView([s,t],a,{animate:!0,duration:.5}),setTimeout(()=>{u.current&&u.current.flyTo([s,t],a,{animate:!0,duration:1.5,easeLinearity:.5})},50),!0}catch(n){return console.error("Error centering map:",n),!1}};i.useEffect(()=>{if(!(r!=null&&r.origin))return;const{lat:s,lng:t}=r.origin;if(typeof s!="number"||typeof t!="number"||isNaN(s)||isNaN(t)){console.error("Invalid coordinates in acceptedTrip:",{lat:s,lng:t});return}if(!v(s,t)){const n=setTimeout(()=>{v(s,t)},500);return()=>clearTimeout(n)}},[r]),i.useEffect(()=>{if(!l)return;const s=JSON.parse(localStorage.getItem("acceptedTrip"));s!=null&&s.origin&&(w(s),setTimeout(()=>{const{lat:a,lng:n}=s.origin;v(a,n)},500));const t=X("searching",a=>{B(a)},a=>{console.error("Error fetching available trips:",a)});return()=>{typeof t=="function"&&t()}},[l]),i.useEffect(()=>{if(!l)return;(async()=>{try{g(!0);const[a,n]=await Promise.all([T(l.uid,!1),T(l.uid,!0)]);N(a),F(n)}catch(a){console.error("Error fetching user trips:",a)}finally{g(!1)}})();const t=Y(l.uid,a=>{if(N(a.filter(n=>n.status!=="completed"&&n.status!=="cancelled")),r){const n=a.find(x=>x.id===r.id);n&&(w(n),localStorage.setItem("acceptedTrip",JSON.stringify(n)))}});return()=>{typeof t=="function"&&t()}},[l,r]);const _=s=>{o?c||O({...s,name:"Destino"}):$({...s,name:"Origen"})},f=s=>{const{name:t,value:a}=s.target;L(n=>({...n,[t]:t==="availableSeats"||t==="price"?parseInt(a)||0:a}))},G=async s=>{if(s.preventDefault(),!o||!c){alert("Por favor selecciona origen y destino");return}try{g(!0),await re({origin:o,destination:c,status:"searching",driverId:l.uid,driverName:l.displayName||"Conductor",driverPhoto:l.photoURL||"",price:d.price||0,availableSeats:d.availableSeats||1,carModel:d.carModel||"",carPlate:d.carPlate||"",estimatedDuration:d.estimatedDuration||"",departureTime:d.departureTime||new Date().toISOString()}),$(null),O(null),L({departureTime:"",availableSeats:1,price:0,carModel:"",carPlate:"",estimatedDuration:""}),alert("¡Viaje creado con éxito!")}catch(t){console.error("Error creating trip:",t),alert(t.message||"Error al crear el viaje. Por favor, inténtalo de nuevo.")}finally{g(!1)}};i.useEffect(()=>{if(r!=null&&r.origin&&u.current){const{lat:s,lng:t}=r.origin;u.current.flyTo([s,t],15,{animate:!0,duration:1.5})}},[r]);const Z=async s=>{if(!s){console.error("No trip ID provided for completion"),alert("No se pudo identificar el viaje a completar");return}if(!y.find(a=>a.id===s)){console.error(`Trip ${s} not found in active trips`),console.log("Available trip IDs:",y.map(a=>a.id)),alert("No se pudo encontrar el viaje activo para completar");return}if(window.confirm("¿Estás seguro de que deseas marcar este viaje como completado?"))try{g(!0),await ne(s,"completed"),r&&r.id===s&&(w(null),localStorage.removeItem("acceptedTrip")),alert("¡Viaje completado con éxito!");const[a,n]=await Promise.all([T(l.uid,!1),T(l.uid,!0)]);N(a),F(n)}catch(a){console.error("Error completing trip:",a),alert(a.message||"Error al completar el viaje. Por favor, inténtalo de nuevo."),(a.code==="not-found"||a.message.includes("no existe"))&&(console.log("Cleaning up local state for non-existent trip"),N(n=>n.filter(x=>x.id!==s)),(r==null?void 0:r.id)===s&&(w(null),localStorage.removeItem("acceptedTrip")))}finally{g(!1)}},M=s=>{if(!s)return"No especificada";try{const t={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"},a=new Date(s);return isNaN(a.getTime())?"Fecha inválida":a.toLocaleDateString("es-ES",t)}catch(t){return console.error("Error formatting date:",t),"Fecha inválida"}},K=s=>{if(console.log("Map instance loaded"),u.current=s,W(s),J.current=!0,C.current){const{lat:a,lng:n,zoom:x}=C.current;v(a,n,x),C.current=null}else if(r!=null&&r.origin){const{lat:a,lng:n}=r.origin;typeof a=="number"&&typeof n=="number"&&v(a,n)}const t=()=>{if(u.current){const a=u.current.getCenter();console.log("Map moved to:",{lat:a.lat,lng:a.lng,zoom:u.current.getZoom()})}};return s.on("moveend",t),()=>{s.off("moveend",t)}};return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-1 space-y-6",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"Panel del Conductor"}),e.jsxs("div",{className:"flex border-b mb-4",children:[e.jsx("button",{className:`flex-1 py-2 font-medium ${m==="available"?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"}`,onClick:()=>h("available"),children:"Viajes Disponibles"}),e.jsx("button",{className:`flex-1 py-2 font-medium ${m==="my-trips"?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"}`,onClick:()=>h("my-trips"),children:"Mis Viajes"}),e.jsx("button",{className:`flex-1 py-2 font-medium ${m==="create-trip"?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"}`,onClick:()=>h("create-trip"),children:e.jsx(ee,{className:"inline mr-1"})})]}),m==="available"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Solicitudes de viaje"}),D.length===0?e.jsx("p",{className:"text-sm text-gray-500 py-4 text-center",children:"No hay viajes disponibles en este momento"}):e.jsx("div",{className:"space-y-4",children:D.map(s=>{var t,a;return e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(b,{className:"text-red-500 mr-2 w-4"}),e.jsx("span",{className:"truncate",children:((t=s.origin)==null?void 0:t.name)||"Origen no especificado"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(b,{className:"text-green-500 mr-2 w-4"}),e.jsx("span",{className:"truncate",children:((a=s.destination)==null?void 0:a.name)||"Destino no especificado"})]}),e.jsxs("div",{className:"flex items-center text-gray-500",children:[e.jsx(R,{className:"mr-2 w-4"}),e.jsx("span",{children:M(s.departureTime)})]}),e.jsxs("div",{className:"flex items-center text-gray-500",children:[e.jsx(V,{className:"mr-2 w-4"}),e.jsxs("span",{children:[s.passengers||1," pasajero",s.passengers!==1?"s":""]})]}),e.jsxs("div",{className:"flex items-center text-lg font-semibold text-blue-600",children:[e.jsx(se,{className:"mr-2"}),"$",(s.price||0).toLocaleString()]}),e.jsx("button",{onClick:()=>handleAcceptTrip(s.id),className:"w-full bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center justify-center",disabled:p,children:p?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Procesando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"mr-2"}),"Aceptar viaje"]})})]},s.id)})})]}),m==="my-trips"&&e.jsxs("div",{className:"space-y-4",children:[q(),P?E.length>0?E.map(s=>{var t,a;return e.jsx("div",{className:"bg-white rounded-lg shadow-md p-4 border-l-4 border-green-500",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium text-gray-900",children:[((t=s.origin)==null?void 0:t.name)||"Origen desconocido"," → ",((a=s.destination)==null?void 0:a.name)||"Destino desconocido"]}),e.jsx("p",{className:"text-sm text-gray-500",children:s.passengerName?`Pasajero: ${s.passengerName}`:"Pasajero no especificado"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Precio: $",s.price||"No especificado"]}),s.completedAt&&e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["Completado: ",M(s.completedAt)]})]}),e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Completado"})]})},s.id)}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"Aún no tienes viajes completados en tu historial."})}):y.length>0?y.map(s=>{var t,a,n,x,z,H;return e.jsxs("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium",children:[((a=(t=s.origin)==null?void 0:t.name)==null?void 0:a.split(",")[0])||"Origen"," → ",((x=(n=s.destination)==null?void 0:n.name)==null?void 0:x.split(",")[0])||"Destino"]}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.status==="accepted"?"bg-blue-100 text-blue-800":s.status==="completed"?"bg-gray-100 text-gray-800":s.status==="in_progress"?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"}`,children:s.status==="accepted"?"Aceptado":s.status==="completed"?"Completado":s.status==="in_progress"?"En curso":"Disponible"})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xl font-bold text-blue-600",children:["$",(s.price||0).toLocaleString()]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[s.passengers," pasajero",s.passengers!==1?"s":""]})]})]}),e.jsxs("div",{className:"space-y-2 text-sm mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(b,{className:"text-red-500 mr-2 w-4"}),e.jsx("span",{className:"truncate",children:((z=s.origin)==null?void 0:z.name)||"Origen no especificado"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(b,{className:"text-green-500 mr-2 w-4"}),e.jsx("span",{className:"truncate",children:((H=s.destination)==null?void 0:H.name)||"Destino no especificado"})]}),e.jsxs("div",{className:"flex items-center text-gray-500",children:[e.jsx(R,{className:"mr-2 w-4"}),e.jsx("span",{children:M(s.departureTime)})]}),s.carModel&&e.jsxs("div",{className:"flex items-center text-gray-500",children:[e.jsx(te,{className:"mr-2 w-4"}),e.jsxs("span",{children:[s.carModel," ",s.carPlate?`• ${s.carPlate}`:""]})]}),s.passengerName&&e.jsxs("div",{className:"mt-2 pt-2 border-t",children:[e.jsx("p",{className:"font-medium text-sm mb-1",children:"Pasajero:"}),e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[e.jsx(V,{className:"mr-2 w-4 text-gray-400"}),e.jsx("span",{children:s.passengerName})]})]})]}),s.status==="accepted"&&e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:()=>Z(s.id),className:"flex-1 bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition-colors",disabled:p,children:p?"Procesando...":"Completar viaje"})})]},s.id)}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{children:"No tienes viajes activos"}),e.jsx("button",{className:"mt-4 text-blue-600 hover:text-blue-800 font-medium",onClick:()=>h("create-trip"),children:"Crear un nuevo viaje"})]})]}),m==="create-trip"&&e.jsxs("form",{onSubmit:G,children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-4",children:"Crear nuevo viaje"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Origen"}),e.jsxs("div",{className:"flex items-center bg-gray-100 rounded-lg p-3",children:[e.jsx(b,{className:"text-red-500 mr-2"}),e.jsx("span",{children:(o==null?void 0:o.name)||"Selecciona en el mapa"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Destino"}),e.jsxs("div",{className:"flex items-center bg-gray-100 rounded-lg p-3",children:[e.jsx(b,{className:"text-green-500 mr-2"}),e.jsx("span",{children:(c==null?void 0:c.name)||"Selecciona en el mapa"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"departureTime",className:"block text-sm font-medium text-gray-700 mb-1",children:"Fecha y hora de salida"}),e.jsx("input",{type:"datetime-local",id:"departureTime",name:"departureTime",value:d.departureTime,onChange:f,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"availableSeats",className:"block text-sm font-medium text-gray-700 mb-1",children:"Asientos disponibles"}),e.jsx("input",{type:"number",id:"availableSeats",name:"availableSeats",min:"1",max:"10",value:d.availableSeats,onChange:f,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"price",className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio por asiento"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"number",id:"price",name:"price",min:"0",value:d.price,onChange:f,className:"w-full pl-7 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"carModel",className:"block text-sm font-medium text-gray-700 mb-1",children:"Modelo del vehículo"}),e.jsx("input",{type:"text",id:"carModel",name:"carModel",value:d.carModel,onChange:f,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"Ej: Toyota Corolla 2020",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"carPlate",className:"block text-sm font-medium text-gray-700 mb-1",children:"Placa del vehículo"}),e.jsx("input",{type:"text",id:"carPlate",name:"carPlate",value:d.carPlate,onChange:f,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"Ej: ABC123",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"estimatedDuration",className:"block text-sm font-medium text-gray-700 mb-1",children:"Duración estimada"}),e.jsx("input",{type:"text",id:"estimatedDuration",name:"estimatedDuration",value:d.estimatedDuration,onChange:f,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"Ej: 45 min"})]}),e.jsx("div",{className:"pt-2",children:e.jsx("button",{type:"submit",disabled:!o||!c||p,className:`w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center ${!o||!c||p?"opacity-50 cursor-not-allowed":"hover:bg-blue-700"}`,children:p?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Creando viaje..."]}):"Publicar viaje"})})]})]})]})}),e.jsx("div",{className:"lg:col-span-2 bg-white rounded-xl shadow-md overflow-hidden w-full h-[400px] lg:h-auto",children:e.jsx("div",{className:"w-full h-full",children:e.jsxs(le,{center:[5.2226,-76.0307],zoom:13,style:{height:"100%",width:"100%",minHeight:"400px"},zoomControl:!0,whenCreated:K,children:[e.jsx(oe,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),(r==null?void 0:r.origin)&&e.jsx(S,{position:[r.origin.lat,r.origin.lng],icon:de,children:e.jsx(k,{children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:["Recoger a ",r.passengerName||"el pasajero"]}),e.jsx("div",{children:r.origin.name||"Ubicación del pasajero"})]})})}),o&&e.jsx(S,{position:[o.lat,o.lng],icon:A,children:e.jsxs(k,{children:["Origen: ",o.name||"Ubicación de recogida"]})}),c&&e.jsx(S,{position:[c.lat,c.lng],icon:A,children:e.jsxs(k,{children:["Destino: ",c.name||"Ubicación de destino"]})}),m==="available"&&D.map(s=>e.jsx(S,{position:[s.origin.lat,s.origin.lng],icon:A,children:e.jsx(k,{children:e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:"Solicitud de viaje"}),e.jsxs("div",{children:["De: ",s.origin.name||"Origen"]}),e.jsxs("div",{children:["A: ",s.destination.name||"Destino"]}),e.jsxs("div",{children:["Pasajeros: ",s.passengers||1]}),e.jsxs("div",{children:["Precio: $",(s.price||0).toLocaleString()]}),e.jsx("button",{onClick:()=>handleAcceptTrip(s.id),className:"mt-2 w-full bg-green-600 text-white py-1 px-2 rounded text-xs font-medium hover:bg-green-700",children:"Aceptar viaje"})]})})},s.id)),m==="create-trip"&&e.jsx(me,{onSelect:_})]})})})]})})})}export{ge as default};
