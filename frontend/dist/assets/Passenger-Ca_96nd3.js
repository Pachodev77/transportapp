import{u as ne,h as m,j as e,n as f,F as ie,k as v,o as ce,p as de}from"./index-DARs2lLX.js";import{r as d,M as le,T as oe,c as y,L as k,P as w,u as me}from"./leaflet-BldE4BD4.js";import{h as N,f as A,k as xe,B as he,q as b,o as _,w as D,d as I,t as ue,C as Ne,D as q,j,E as z}from"./firebase-D_9l9YAU.js";import{S as t,B as p}from"./Button-93E7zHCn.js";import{a as pe}from"./react-DcIcrUde.js";const T=new k.Icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function ge({onSelect:i}){return me({click(g){i(g.latlng)}}),null}const L=i=>{if(!i)return"";const g={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"};return new Date(i).toLocaleDateString("es-CO",g)};function Re(){const{currentUser:i}=ne(),g=pe(),[l,U]=d.useState(null),[o,P]=d.useState(null),[u,h]=d.useState(!1),[V,H]=d.useState([]),[M,Q]=d.useState([]),[B,W]=d.useState([]),[E,Ee]=d.useState(null),[F,x]=d.useState(""),[R,C]=d.useState("search"),[J,K]=d.useState(null),[O,X]=d.useState(null);d.useEffect(()=>{if(E!=null&&E.driverId){const s=N(m,"locations",E.driverId),a=A(s,r=>{r.exists()&&X(r.data().location)});return()=>{a()}}},[E]),d.useEffect(()=>{const s=navigator.geolocation.watchPosition(a=>{const{latitude:r,longitude:n}=a.coords;if(K([r,n]),i){const c=N(m,"locations",i.uid);xe(c,{location:new he(r,n),updatedAt:j()})}},a=>{console.error("Error watching position:",a)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0});return()=>{navigator.geolocation.clearWatch(s)}},[i]);const Y=[{id:"search",name:t.BUSCAR_VIAJE},{id:"my-requests",name:t.MIS_SOLICITUDES},{id:"my-trips",name:t.MIS_VIAJES}],Z=async s=>{try{const a=await ee(s.lat,s.lng);l?o||P({lat:s.lat,lng:s.lng,name:t.DESTINO,address:a||t.UBICACION_SELECCIONADA}):U({lat:s.lat,lng:s.lng,name:t.ORIGEN,address:a||t.UBICACION_SELECCIONADA})}catch(a){console.error("Error getting address:",a),x(t.ERROR_OBTENER_DIRECCION)}},ee=async(s,a)=>{try{return(await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${a}&zoom=18&addressdetails=1`)).json()).display_name||t.UBICACION_SELECCIONADA}catch(r){return console.error("Error getting address:",r),t.UBICACION_SELECCIONADA}},se=async s=>{if(window.confirm(t.CONFIRMAR_CANCELAR_SOLICITUD))try{h(!0);const a=N(m,"rideRequests",s);await ue(a,{status:"cancelled",updatedAt:new Date().toISOString()})}catch(a){console.error("Error canceling ride request:",a),x(t.ERROR_CANCELAR_SOLICITUD)}finally{h(!1)}},te=async()=>{if(!l||!o){x(t.SELECCIONAR_ORIGEN_DESTINO);return}if(!i){g("/login",{state:{from:"passenger"}});return}h(!0),x("");try{const s={passengerId:i.uid,passengerName:i.displayName||t.USUARIO,passengerEmail:i.email,origin:{lat:l.lat,lng:l.lng,name:l.name,address:l.address},destination:{lat:o.lat,lng:o.lng,name:o.name,address:o.address},status:"pending",timestamp:Date.now(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};await Ne(I(m,"rideRequests"),s),U(null),P(null)}catch(s){console.error(t.ERROR_SOLICITAR_VIAJE,s),x(t.ERROR_OCURRIDO_SOLICITAR_VIAJE)}finally{h(!1)}};d.useEffect(()=>{if(!i)return;const s=b(I(m,"trips"),D("status","==","available"),_("departureTime","asc")),a=A(s,r=>{const n=[];r.forEach(c=>{n.push({id:c.id,...c.data()})}),W(n)});return()=>a()},[i]),d.useEffect(()=>{if(!i)return;const s=b(I(m,"rideRequests"),D("passengerId","==",i.uid),_("createdAt","desc")),a=A(s,r=>{const n=[];r.forEach(c=>{n.push({id:c.id,...c.data()})}),Q(n)});return()=>a()},[i]),d.useEffect(()=>{if(!i)return;const s=b(I(m,"bookings"),D("passengerId","==",i.uid),_("createdAt","desc")),a=A(s,r=>{const n=[];r.forEach(c=>{n.push({id:c.id,...c.data()})}),H(n)});return()=>a()},[i]);const ae=async s=>{if(!i){g("/login",{state:{from:"passenger"}});return}h(!0),x("");try{await q(m,async a=>{const r=N(m,"trips",s.id),n=await a.get(r);if(!n.exists()||n.data().availableSeats<=0)throw new Error("No hay asientos disponibles en este viaje.");a.update(r,{availableSeats:z(-1),updatedAt:j()});const c=N(I(m,"bookings"));a.set(c,{tripId:s.id,passengerId:i.uid,passengerName:i.displayName||t.USUARIO,driverId:s.driverId,driverName:s.driverName,origin:s.origin,destination:s.destination,departureTime:s.departureTime,price:s.price,status:"pending",createdAt:j(),updatedAt:j()})}),alert("¡Viaje reservado con éxito!")}catch(a){console.error(t.ERROR_RESERVAR_VIAJE,a),x(a.message||t.ERROR_OCURRIDO_RESERVAR_VIAJE)}finally{h(!1)}},re=async s=>{if(window.confirm(t.CONFIRMAR_CANCELAR_RESERVA)){h(!0),x("");try{await q(m,async a=>{const r=N(m,"bookings",s),n=await a.get(r);if(!n.exists())throw new Error("Esta reserva ya no existe.");const c=n.data();if(a.update(r,{status:"cancelled",updatedAt:j()}),c.status==="confirmed"){const S=N(m,"trips",c.tripId);a.update(S,{availableSeats:z(1),updatedAt:j()})}}),alert("¡Reserva cancelada con éxito!")}catch(a){console.error(t.ERROR_CANCELAR_RESERVA,a),x(a.message||t.ERROR_OCURRIDO_CANCELAR_RESERVA)}finally{h(!1)}}};return e.jsxs("div",{className:"min-h-screen bg-light flex flex-col lg:flex-row",children:[e.jsxs("div",{className:"w-full lg:w-1/3 bg-white p-6 overflow-y-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6 text-dark",children:t.SOLICITAR_VIAJE}),e.jsx("div",{className:"flex border-b mb-4",children:Y.map(s=>e.jsx(p,{className:`flex-1 py-2 font-medium ${R===s.id?"text-primary border-b-2 border-primary":"text-secondary"}`,onClick:()=>C(s.id),children:s.name},s.id))}),F&&e.jsx("div",{className:"mb-4 p-3 bg-danger text-white rounded-lg",children:F}),R==="my-requests"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-dark",children:t.MIS_SOLICITUDES_DE_VIAJE}),M.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-secondary mb-4",children:t.NO_TIENES_SOLICITUDES}),e.jsx(p,{onClick:()=>C("search"),className:"text-primary hover:text-primary-dark font-medium",children:t.SOLICITAR_UN_VIAJE_AHORA})]}):e.jsx("div",{className:"space-y-4",children:M.map(s=>{var a,r;return e.jsx("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium text-dark",children:[((a=s.origin)==null?void 0:a.address)||t.ORIGEN," → ",((r=s.destination)==null?void 0:r.address)||t.DESTINO]}),e.jsx("p",{className:"text-sm text-secondary mt-1",children:L(s.createdAt)}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.status==="pending"?"bg-warning text-white":s.status==="accepted"?"bg-success text-white":"bg-secondary text-white"}`,children:s.status==="pending"?t.PENDIENTE:s.status==="accepted"?t.ACEPTADO:t.CANCELADO})})]}),s.status==="pending"&&e.jsx(p,{onClick:()=>se(s.id),className:"text-danger hover:text-danger-dark text-sm font-medium",disabled:u,children:u?t.CANCELANDO:t.CANCELAR})]})},s.id)})})]}):R==="search"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 p-4 bg-primary-light rounded-lg",children:[e.jsxs("p",{className:"text-sm text-primary-dark mb-3",children:[e.jsx("span",{className:"font-semibold",children:t.INSTRUCCIONES})," ",t.SELECCIONA_ORIGEN_DESTINO_MAPA]}),e.jsxs("ol",{className:"list-decimal list-inside text-sm space-y-1 text-primary-dark",children:[e.jsx("li",{children:t.SELECCIONA_PUNTO_ORIGEN}),e.jsx("li",{children:t.SELECCIONA_PUNTO_DESTINO}),e.jsx("li",{children:t.CONFIRMA_SOLICITUD_VIAJE})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-dark mb-1",children:t.ORIGEN}),e.jsxs("div",{className:"flex items-center bg-light rounded-lg p-3",children:[e.jsx(f,{className:"text-danger mr-2"}),e.jsx("span",{children:(l==null?void 0:l.address)||t.SELECCIONA_EN_MAPA})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-dark mb-1",children:t.DESTINO}),e.jsxs("div",{className:"flex items-center bg-light rounded-lg p-3",children:[e.jsx(f,{className:"text-success mr-2"}),e.jsx("span",{children:(o==null?void 0:o.address)||t.SELECCIONA_EN_MAPA})]})]}),e.jsx(p,{onClick:te,disabled:!l||!o||u,children:u?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"animate-spin"}),e.jsx("span",{children:t.BUSCANDO_CONDUCTOR})]}):e.jsxs(e.Fragment,{children:[e.jsx(v,{}),e.jsx("span",{children:t.SOLICITAR_VIAJE})]})}),l&&o&&e.jsx("p",{className:"mt-2 text-xs text-center text-secondary",children:t.CONDUCTORES_CERCANOS_NOTIFICADOS})]}),B.length>0&&e.jsxs("div",{className:"mt-8",children:[e.jsx("h2",{className:"text-lg font-semibold text-dark mb-4",children:t.VIAJES_DISPONIBLES}),e.jsx("div",{className:"space-y-4",children:B.map(s=>{var a,r,n;return e.jsxs("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-dark",children:s.driverName}),e.jsxs("div",{className:"flex items-center text-warning text-sm",children:[e.jsx(ce,{className:"mr-1"}),e.jsxs("span",{children:[s.rating," (",s.reviewCount," ",t.RESENAS,")"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xl font-bold text-primary",children:["$",(a=s.price)==null?void 0:a.toLocaleString()]}),e.jsx("div",{className:"text-sm text-secondary",children:s.availableSeats>0?`${s.availableSeats} ${s.availableSeats>1?t.ASIENTOS:t.ASIENTO} ${t.DISPONIBLE}`:t.SIN_CUPOS})]})]}),e.jsxs("div",{className:"space-y-2 text-sm mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(f,{className:"text-danger mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(r=s.origin)==null?void 0:r.address})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(f,{className:"text-success mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(n=s.destination)==null?void 0:n.address})]}),e.jsxs("div",{className:"flex items-center text-secondary",children:[e.jsx(de,{className:"mr-2 w-4"}),e.jsx("span",{children:L(s.departureTime)})]}),e.jsxs("div",{className:"flex items-center text-secondary",children:[e.jsx(v,{className:"mr-2 w-4"}),e.jsxs("span",{children:[s.carModel," • ",s.carPlate]})]})]}),e.jsx(p,{onClick:()=>ae(s),disabled:!s.availableSeats||u,className:`w-full ${s.availableSeats>0?"bg-success hover:bg-success-dark":"bg-secondary cursor-not-allowed"}`,children:s.availableSeats>0?t.RESERVAR_AHORA:t.SIN_CUPOS_DISPONIBLES})]},s.id)})})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-dark",children:t.MIS_VIAJES}),V.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(v,{className:"mx-auto text-secondary text-4xl mb-2"}),e.jsx("p",{className:"text-secondary",children:t.NO_TIENES_VIAJES_PROGRAMADOS}),e.jsx(p,{onClick:()=>C("search"),className:"mt-2 text-primary hover:underline text-sm",children:t.BUSCAR_VIAJES_DISPONIBLES})]}):e.jsx("div",{className:"space-y-4",children:V.map(s=>{var a,r,n,c,S,$,G;return e.jsxs("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium text-dark",children:[(r=(a=s.origin)==null?void 0:a.address)==null?void 0:r.split(",")[0]," → ",(c=(n=s.destination)==null?void 0:n.address)==null?void 0:c.split(",")[0]]}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.status==="confirmed"?"bg-success text-white":s.status==="cancelled"?"bg-secondary text-white":"bg-warning text-white"}`,children:s.status==="confirmed"?t.CONFIRMADO:s.status==="pending"?t.PENDIENTE:s.status==="cancelled"?t.CANCELADO:s.status})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xl font-bold text-primary",children:["$",(S=s.price)==null?void 0:S.toLocaleString()]}),e.jsx("div",{className:"text-sm text-secondary",children:s.departureTime&&L(s.departureTime)})]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(f,{className:"text-danger mr-2 w-4"}),e.jsx("span",{className:"truncate",children:($=s.origin)==null?void 0:$.address})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(f,{className:"text-success mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(G=s.destination)==null?void 0:G.address})]}),s.driverName&&e.jsxs("div",{className:"flex items-center text-secondary",children:[e.jsx("span",{className:"mr-2",children:t.CONDUCTOR}),e.jsx("span",{children:s.driverName})]})]}),s.status==="pending"&&e.jsx("div",{className:"mt-4 pt-3 border-t",children:e.jsx(p,{onClick:()=>re(s.id),disabled:u,className:"w-full bg-danger text-white py-2 rounded-lg font-medium hover:bg-danger-dark transition-colors",children:u?t.CANCELANDO:t.CANCELAR_RESERVA})})]},s.id)})})]})]}),e.jsx("div",{className:"w-full lg:w-2/3 h-64 lg:h-full",children:e.jsxs(le,{center:J||[0,0],zoom:J?13:2,style:{height:"100%",width:"100%",minHeight:"400px"},children:[e.jsx(oe,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),e.jsx(ge,{onSelect:Z}),l&&e.jsx(y,{position:[l.lat,l.lng],icon:T,children:e.jsxs(w,{children:[t.ORIGEN_PUNTOS,l.address]})}),o&&e.jsx(y,{position:[o.lat,o.lng],icon:new k.Icon({...T.options,iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",iconRetinaUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png"}),children:e.jsxs(w,{children:[t.DESTINO_PUNTOS,o.address]})}),O&&e.jsx(y,{position:[O.latitude,O.longitude],icon:new k.Icon({...T.options,iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",iconRetinaUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png"}),children:e.jsx(w,{children:e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"font-medium",children:E.driverName})})})})]})})]})}export{Re as default};
//# sourceMappingURL=Passenger-Ca_96nd3.js.map
