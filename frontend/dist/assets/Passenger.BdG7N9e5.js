import{a as Y,r as c,j as e,t as p,h as Z,F as I,v as ee,w as se,M as ae,T as te,x as N,P as b,y as re,z as ne}from"./vendor-react.CmGka2D2.js";import{q as T,o as U,w as k,c as j,d as D,h as y,u as w,z as B,j as f}from"./vendor-firebase.Cn81kGj9.js";import{u as ie,d as m}from"./index.CDa2tX_0.js";import{L as R}from"./vendor-leaflet.DZO0XrE_.js";import"./vendor.C5NWDL7J.js";const S=new R.Icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function le({onSelect:t}){return ne({click(h){t(h.latlng)}}),null}const C=t=>{if(!t)return"";const h={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"};return new Date(t).toLocaleDateString("es-CO",h)};function pe(){const{currentUser:t}=ie(),h=Y(),[r,M]=c.useState(null),[n,$]=c.useState(null),[u,x]=c.useState(!1),[v,z]=c.useState([]),[O,V]=c.useState([]),[E,Q]=c.useState([]),[ce,de]=c.useState(null),[P,o]=c.useState(""),[g,A]=c.useState("search"),_=[{id:"search",name:"Buscar viaje"},{id:"my-requests",name:"Mis solicitudes"},{id:"my-trips",name:"Mis viajes"}],G=async s=>{try{const a=await H(s.lat,s.lng);r?n||$({lat:s.lat,lng:s.lng,name:"Destino",address:a||"Ubicación seleccionada"}):M({lat:s.lat,lng:s.lng,name:"Origen",address:a||"Ubicación seleccionada"})}catch(a){console.error("Error getting address:",a),o("Error al obtener la dirección. Intenta de nuevo.")}},H=async(s,a)=>{try{return(await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${a}&zoom=18&addressdetails=1`)).json()).display_name||"Ubicación seleccionada"}catch(i){return console.error("Error getting address:",i),"Ubicación seleccionada"}},J=async s=>{if(window.confirm("¿Estás seguro de que deseas cancelar esta solicitud de viaje?"))try{x(!0);const a=y(m,"rideRequests",s);await w(a,{status:"cancelled",updatedAt:new Date().toISOString()})}catch(a){console.error("Error canceling ride request:",a),o("No se pudo cancelar la solicitud. Por favor, inténtalo de nuevo.")}finally{x(!1)}},K=async()=>{if(!r||!n){o("Por favor selecciona origen y destino en el mapa");return}if(!t){h("/login",{state:{from:"passenger"}});return}x(!0),o("");try{const s={passengerId:t.uid,passengerName:t.displayName||"Usuario",passengerEmail:t.email,origin:{lat:r.lat,lng:r.lng,name:r.name,address:r.address},destination:{lat:n.lat,lng:n.lng,name:n.name,address:n.address},status:"pending",timestamp:Date.now(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};await B(j(m,"rideRequests"),s),M(null),$(null)}catch(s){console.error("Error al solicitar viaje:",s),o("Ocurrió un error al solicitar el viaje. Por favor intenta de nuevo.")}finally{x(!1)}};c.useEffect(()=>{if(!t)return;const s=T(j(m,"trips"),k("status","==","available"),U("departureTime","asc")),a=D(s,i=>{const l=[];i.forEach(d=>{l.push({id:d.id,...d.data()})}),Q(l)});return()=>a()},[t]),c.useEffect(()=>{if(!t)return;const s=T(j(m,"rideRequests"),k("passengerId","==",t.uid),U("createdAt","desc")),a=D(s,i=>{const l=[];i.forEach(d=>{l.push({id:d.id,...d.data()})}),V(l)});return()=>a()},[t]),c.useEffect(()=>{if(!t)return;const s=T(j(m,"bookings"),k("passengerId","==",t.uid),U("createdAt","desc")),a=D(s,i=>{const l=[];i.forEach(d=>{l.push({id:d.id,...d.data()})}),z(l)});return()=>a()},[t]);const W=async s=>{if(!t){h("/login",{state:{from:"passenger"}});return}x(!0),o("");try{const a={tripId:s.id,passengerId:t.uid,passengerName:t.displayName||"Usuario",driverId:s.driverId,driverName:s.driverName,origin:s.origin,destination:s.destination,departureTime:s.departureTime,price:s.price,status:"pending",createdAt:f(),updatedAt:f()};await B(j(m,"bookings"),a),await w(y(m,"trips",s.id),{availableSeats:s.availableSeats-1,updatedAt:f()})}catch(a){console.error("Error al reservar viaje:",a),o("Ocurrió un error al reservar el viaje. Por favor intenta de nuevo.")}finally{x(!1)}},X=async s=>{if(window.confirm("¿Estás seguro de que deseas cancelar esta reserva?")){x(!0),o("");try{await w(y(m,"bookings",s),{status:"cancelled",updatedAt:f()});const a=v.find(i=>i.id===s);a&&a.status==="confirmed"&&await w(y(m,"trips",a.tripId),{availableSeats:increment(1),updatedAt:f()})}catch(a){console.error("Error al cancelar reserva:",a),o("Ocurrió un error al cancelar la reserva. Por favor intenta de nuevo.")}finally{x(!1)}}};return e.jsx("div",{className:"min-h-screen bg-gray-100",children:e.jsxs("div",{className:"flex h-screen",children:[e.jsxs("div",{className:"w-1/3 bg-white p-6 overflow-y-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"Solicitar Viaje"}),e.jsx("div",{className:"flex border-b mb-4",children:_.map(s=>e.jsx("button",{className:`flex-1 py-2 font-medium ${g===s.id?"text-blue-600 border-b-2 border-blue-600":"text-gray-500"}`,onClick:()=>A(s.id),children:s.name},s.id))}),P&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 text-red-700 rounded-lg",children:P}),g==="my-requests"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Mis Solicitudes de Viaje"}),O.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-500 mb-4",children:"No tienes solicitudes de viaje activas."}),e.jsx("button",{onClick:()=>A("search"),className:"text-blue-600 hover:text-blue-800 font-medium",children:"Solicitar un viaje ahora"})]}):e.jsx("div",{className:"space-y-4",children:O.map(s=>{var a,i;return e.jsx("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium",children:[((a=s.origin)==null?void 0:a.address)||"Origen"," → ",((i=s.destination)==null?void 0:i.address)||"Destino"]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:C(s.createdAt)}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.status==="pending"?"bg-yellow-100 text-yellow-800":s.status==="accepted"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.status==="pending"?"Pendiente":s.status==="accepted"?"Aceptado":"Cancelado"})})]}),s.status==="pending"&&e.jsx("button",{onClick:()=>J(s.id),className:"text-red-600 hover:text-red-800 text-sm font-medium",disabled:u,children:u?"Cancelando...":"Cancelar"})]})},s.id)})})]}):g==="search"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 p-4 bg-blue-50 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-blue-800 mb-3",children:[e.jsx("span",{className:"font-semibold",children:"Instrucciones:"})," Selecciona origen y destino en el mapa."]}),e.jsxs("ol",{className:"list-decimal list-inside text-sm space-y-1 text-blue-800",children:[e.jsx("li",{children:"Selecciona el punto de origen"}),e.jsx("li",{children:"Selecciona el punto de destino"}),e.jsx("li",{children:"Confirma tu solicitud de viaje"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Origen"}),e.jsxs("div",{className:"flex items-center bg-gray-100 rounded-lg p-3",children:[e.jsx(p,{className:"text-red-500 mr-2"}),e.jsx("span",{children:(r==null?void 0:r.address)||"Selecciona en el mapa"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Destino"}),e.jsxs("div",{className:"flex items-center bg-gray-100 rounded-lg p-3",children:[e.jsx(p,{className:"text-green-500 mr-2"}),e.jsx("span",{children:(n==null?void 0:n.address)||"Selecciona en el mapa"})]})]}),e.jsx("button",{onClick:K,disabled:!r||!n||u,className:`w-full py-3 px-4 rounded-lg text-white font-medium transition-colors ${!r||!n||u?"bg-gray-300 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} flex items-center justify-center space-x-2`,children:u?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"animate-spin"}),e.jsx("span",{children:"Buscando conductor..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{}),e.jsx("span",{children:"Solicitar Viaje"})]})}),r&&n&&e.jsx("p",{className:"mt-2 text-xs text-center text-gray-500",children:"Los conductores cercanos serán notificados de tu solicitud"})]}),E.length>0&&e.jsxs("div",{className:"mt-8",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Viajes disponibles"}),e.jsx("div",{className:"space-y-4",children:E.map(s=>{var a,i,l;return e.jsxs("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:s.driverName}),e.jsxs("div",{className:"flex items-center text-yellow-400 text-sm",children:[e.jsx(ee,{className:"mr-1"}),e.jsxs("span",{children:[s.rating," (",s.reviewCount," reseñas)"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xl font-bold text-blue-600",children:["$",(a=s.price)==null?void 0:a.toLocaleString()]}),e.jsx("div",{className:"text-sm text-gray-500",children:s.availableSeats>0?`${s.availableSeats} asiento${s.availableSeats!==1?"s":""} disp.`:"Sin cupos"})]})]}),e.jsxs("div",{className:"space-y-2 text-sm mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(p,{className:"text-red-500 mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(i=s.origin)==null?void 0:i.address})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(p,{className:"text-green-500 mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(l=s.destination)==null?void 0:l.address})]}),e.jsxs("div",{className:"flex items-center text-gray-500",children:[e.jsx(se,{className:"mr-2 w-4"}),e.jsx("span",{children:C(s.departureTime)})]}),e.jsxs("div",{className:"flex items-center text-gray-500",children:[e.jsx(I,{className:"mr-2 w-4"}),e.jsxs("span",{children:[s.carModel," • ",s.carPlate]})]})]}),e.jsx("button",{onClick:()=>W(s),disabled:!s.availableSeats||u,className:`w-full ${s.availableSeats>0?"bg-green-600 hover:bg-green-700":"bg-gray-400 cursor-not-allowed"} text-white py-2 rounded-lg font-medium transition-colors`,children:s.availableSeats>0?"Reservar ahora":"Sin cupos disponibles"})]},s.id)})})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Mis viajes"}),v.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(I,{className:"mx-auto text-gray-300 text-4xl mb-2"}),e.jsx("p",{className:"text-gray-500",children:"No tienes viajes programados"}),e.jsx("button",{onClick:()=>A("search"),className:"mt-2 text-blue-600 hover:underline text-sm",children:"Buscar viajes disponibles"})]}):e.jsx("div",{className:"space-y-4",children:v.map(s=>{var a,i,l,d,L,q,F;return e.jsxs("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium",children:[(i=(a=s.origin)==null?void 0:a.address)==null?void 0:i.split(",")[0]," → ",(d=(l=s.destination)==null?void 0:l.address)==null?void 0:d.split(",")[0]]}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.status==="confirmed"?"bg-green-100 text-green-800":s.status==="cancelled"?"bg-gray-100 text-gray-800":"bg-yellow-100 text-yellow-800"}`,children:s.status==="confirmed"?"Confirmado":s.status==="pending"?"Pendiente":s.status==="cancelled"?"Cancelado":s.status})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xl font-bold text-blue-600",children:["$",(L=s.price)==null?void 0:L.toLocaleString()]}),e.jsx("div",{className:"text-sm text-gray-500",children:s.departureTime&&C(s.departureTime)})]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(p,{className:"text-red-500 mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(q=s.origin)==null?void 0:q.address})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(p,{className:"text-green-500 mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(F=s.destination)==null?void 0:F.address})]}),s.driverName&&e.jsxs("div",{className:"flex items-center text-gray-500",children:[e.jsx("span",{className:"mr-2",children:"Conductor:"}),e.jsx("span",{children:s.driverName})]})]}),s.status==="pending"&&e.jsx("div",{className:"mt-4 pt-3 border-t",children:e.jsx("button",{onClick:()=>X(s.id),disabled:u,className:"w-full bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700 transition-colors",children:u?"Cancelando...":"Cancelar reserva"})})]},s.id)})})]})]}),e.jsx("div",{className:"w-2/3 h-full",children:e.jsxs(ae,{center:[4.7109,-74.0721],zoom:13,style:{height:"100%",width:"100%"},children:[e.jsx(te,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),e.jsx(le,{onSelect:G}),r&&e.jsx(N,{position:[r.lat,r.lng],icon:S,children:e.jsxs(b,{children:["Origen: ",r.address]})}),n&&e.jsx(N,{position:[n.lat,n.lng],icon:new R.Icon({...S.options,iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",iconRetinaUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png"}),children:e.jsxs(b,{children:["Destino: ",n.address]})}),r&&n&&e.jsx(re,{positions:[[r.lat,r.lng],[n.lat,n.lng]],color:"blue",weight:3,opacity:.7}),g==="search"&&E.map(s=>{var a;return e.jsx(N,{position:[s.origin.lat,s.origin.lng],icon:new R.Icon({...S.options,iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",iconRetinaUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png"}),children:e.jsx(b,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium",children:s.driverName}),e.jsxs("p",{children:["$",(a=s.price)==null?void 0:a.toLocaleString()]}),e.jsxs("p",{children:[s.availableSeats," asiento",s.availableSeats!==1?"s":""," disponible",s.availableSeats!==1?"s":""]}),e.jsx("p",{children:C(s.departureTime)})]})})},s.id)}),g==="my-trips"&&v.map(s=>{var a;return e.jsx(N,{position:[s.origin.lat,s.origin.lng],icon:new R.Icon({...S.options,iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png",iconRetinaUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png"}),children:e.jsx(b,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"font-medium",children:[s.origin.address.split(",")[0]," → ",s.destination.address.split(",")[0]]}),e.jsxs("p",{children:["$",(a=s.price)==null?void 0:a.toLocaleString()]}),e.jsx("p",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${s.status==="confirmed"?"bg-green-100 text-green-800":s.status==="cancelled"?"bg-gray-100 text-gray-800":"bg-yellow-100 text-yellow-800"}`,children:s.status==="confirmed"?"Confirmado":s.status==="pending"?"Pendiente":s.status==="cancelled"?"Cancelado":s.status})]})})},s.id)})]})})]})})}export{pe as default};
