import{u as ne,a as ie,r as c,i as E,k as m,q as A,s as ce,G as de,t as y,v as w,w as b,x as S,j as e,y as I,F as le,n as _,z as oe,A as me,l as f,B as z,C as j}from"./index-DCFZ7VU2.js";import{S as a,B as N,M as xe,T as he,a as D,L as k,P as T,u as ue}from"./Button-aNmsDZFI.js";const L=new k.Icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function Ne({onSelect:n}){return ue({click(p){n(p.latlng)}}),null}const U=n=>{if(!n)return"";const p={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"};return new Date(n).toLocaleDateString("es-CO",p)};function Ie(){const{currentUser:n}=ne(),p=ie(),[d,P]=c.useState(null),[l,M]=c.useState(null),[u,h]=c.useState(!1),[R,H]=c.useState([]),[V,Q]=c.useState([]),[B,W]=c.useState([]),[g,pe]=c.useState(null),[F,x]=c.useState(""),[C,O]=c.useState("search"),[J,K]=c.useState(null),[v,X]=c.useState(null);c.useEffect(()=>{if(g!=null&&g.driverId){const s=E(m,"locations",g.driverId),t=A(s,r=>{r.exists()&&X(r.data().location)});return()=>{t()}}},[g]),c.useEffect(()=>{const s=navigator.geolocation.watchPosition(t=>{const{latitude:r,longitude:i}=t.coords;if(K([r,i]),n){const o=E(m,"locations",n.uid);ce(o,{location:new de(r,i),updatedAt:j()})}},t=>{console.error("Error watching position:",t)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0});return()=>{navigator.geolocation.clearWatch(s)}},[n]);const Y=[{id:"search",name:a.BUSCAR_VIAJE},{id:"my-requests",name:a.MIS_SOLICITUDES},{id:"my-trips",name:a.MIS_VIAJES}],Z=async s=>{try{const t=await ee(s.lat,s.lng);d?l||M({lat:s.lat,lng:s.lng,name:a.DESTINO,address:t||a.UBICACION_SELECCIONADA}):P({lat:s.lat,lng:s.lng,name:a.ORIGEN,address:t||a.UBICACION_SELECCIONADA})}catch(t){console.error("Error getting address:",t),x(a.ERROR_OBTENER_DIRECCION)}},ee=async(s,t)=>{try{return(await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${t}&zoom=18&addressdetails=1`)).json()).display_name||a.UBICACION_SELECCIONADA}catch(r){return console.error("Error getting address:",r),a.UBICACION_SELECCIONADA}},se=async s=>{if(window.confirm(a.CONFIRMAR_CANCELAR_SOLICITUD))try{h(!0);const t=E(m,"rideRequests",s);await f(t,{status:"cancelled",updatedAt:new Date().toISOString()})}catch(t){console.error("Error canceling ride request:",t),x(a.ERROR_CANCELAR_SOLICITUD)}finally{h(!1)}},ae=async()=>{if(!d||!l){x(a.SELECCIONAR_ORIGEN_DESTINO);return}if(!n){p("/login",{state:{from:"passenger"}});return}h(!0),x("");try{const s={passengerId:n.uid,passengerName:n.displayName||a.USUARIO,passengerEmail:n.email,origin:{lat:d.lat,lng:d.lng,name:d.name,address:d.address},destination:{lat:l.lat,lng:l.lng,name:l.name,address:l.address},status:"pending",timestamp:Date.now(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};await z(S(m,"rideRequests"),s),P(null),M(null)}catch(s){console.error(a.ERROR_SOLICITAR_VIAJE,s),x(a.ERROR_OCURRIDO_SOLICITAR_VIAJE)}finally{h(!1)}};c.useEffect(()=>{if(!n)return;const s=y(S(m,"trips"),b("status","==","available"),w("departureTime","asc")),t=A(s,r=>{const i=[];r.forEach(o=>{i.push({id:o.id,...o.data()})}),W(i)});return()=>t()},[n]),c.useEffect(()=>{if(!n)return;const s=y(S(m,"rideRequests"),b("passengerId","==",n.uid),w("createdAt","desc")),t=A(s,r=>{const i=[];r.forEach(o=>{i.push({id:o.id,...o.data()})}),Q(i)});return()=>t()},[n]),c.useEffect(()=>{if(!n)return;const s=y(S(m,"bookings"),b("passengerId","==",n.uid),w("createdAt","desc")),t=A(s,r=>{const i=[];r.forEach(o=>{i.push({id:o.id,...o.data()})}),H(i)});return()=>t()},[n]);const te=async s=>{if(!n){p("/login",{state:{from:"passenger"}});return}h(!0),x("");try{const t={tripId:s.id,passengerId:n.uid,passengerName:n.displayName||a.USUARIO,driverId:s.driverId,driverName:s.driverName,origin:s.origin,destination:s.destination,departureTime:s.departureTime,price:s.price,status:"pending",createdAt:j(),updatedAt:j()};await z(S(m,"bookings"),t),await f(E(m,"trips",s.id),{availableSeats:s.availableSeats-1,updatedAt:j()})}catch(t){console.error(a.ERROR_RESERVAR_VIAJE,t),x(a.ERROR_OCURRIDO_RESERVAR_VIAJE)}finally{h(!1)}},re=async s=>{if(window.confirm(a.CONFIRMAR_CANCELAR_RESERVA)){h(!0),x("");try{await f(E(m,"bookings",s),{status:"cancelled",updatedAt:j()});const t=R.find(r=>r.id===s);t&&t.status==="confirmed"&&await f(E(m,"trips",t.tripId),{availableSeats:increment(1),updatedAt:j()})}catch(t){console.error(a.ERROR_CANCELAR_RESERVA,t),x(a.ERROR_OCURRIDO_CANCELAR_RESERVA)}finally{h(!1)}}};return e.jsxs("div",{className:"min-h-screen bg-light flex flex-col lg:flex-row",children:[e.jsxs("div",{className:"w-full lg:w-1/3 bg-white p-6 overflow-y-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6 text-dark",children:a.SOLICITAR_VIAJE}),e.jsx("div",{className:"flex border-b mb-4",children:Y.map(s=>e.jsx(N,{className:`flex-1 py-2 font-medium ${C===s.id?"text-primary border-b-2 border-primary":"text-secondary"}`,onClick:()=>O(s.id),children:s.name},s.id))}),F&&e.jsx("div",{className:"mb-4 p-3 bg-danger text-white rounded-lg",children:F}),C==="my-requests"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-dark",children:a.MIS_SOLICITUDES_DE_VIAJE}),V.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-secondary mb-4",children:a.NO_TIENES_SOLICITUDES}),e.jsx(N,{onClick:()=>O("search"),className:"text-primary hover:text-primary-dark font-medium",children:a.SOLICITAR_UN_VIAJE_AHORA})]}):e.jsx("div",{className:"space-y-4",children:V.map(s=>{var t,r;return e.jsx("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium text-dark",children:[((t=s.origin)==null?void 0:t.address)||a.ORIGEN," → ",((r=s.destination)==null?void 0:r.address)||a.DESTINO]}),e.jsx("p",{className:"text-sm text-secondary mt-1",children:U(s.createdAt)}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.status==="pending"?"bg-warning text-white":s.status==="accepted"?"bg-success text-white":"bg-secondary text-white"}`,children:s.status==="pending"?a.PENDIENTE:s.status==="accepted"?a.ACEPTADO:a.CANCELADO})})]}),s.status==="pending"&&e.jsx(N,{onClick:()=>se(s.id),className:"text-danger hover:text-danger-dark text-sm font-medium",disabled:u,children:u?a.CANCELANDO:a.CANCELAR})]})},s.id)})})]}):C==="search"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 p-4 bg-primary-light rounded-lg",children:[e.jsxs("p",{className:"text-sm text-primary-dark mb-3",children:[e.jsx("span",{className:"font-semibold",children:a.INSTRUCCIONES})," ",a.SELECCIONA_ORIGEN_DESTINO_MAPA]}),e.jsxs("ol",{className:"list-decimal list-inside text-sm space-y-1 text-primary-dark",children:[e.jsx("li",{children:a.SELECCIONA_PUNTO_ORIGEN}),e.jsx("li",{children:a.SELECCIONA_PUNTO_DESTINO}),e.jsx("li",{children:a.CONFIRMA_SOLICITUD_VIAJE})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-dark mb-1",children:a.ORIGEN}),e.jsxs("div",{className:"flex items-center bg-light rounded-lg p-3",children:[e.jsx(I,{className:"text-danger mr-2"}),e.jsx("span",{children:(d==null?void 0:d.address)||a.SELECCIONA_EN_MAPA})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-dark mb-1",children:a.DESTINO}),e.jsxs("div",{className:"flex items-center bg-light rounded-lg p-3",children:[e.jsx(I,{className:"text-success mr-2"}),e.jsx("span",{children:(l==null?void 0:l.address)||a.SELECCIONA_EN_MAPA})]})]}),e.jsx(N,{onClick:ae,disabled:!d||!l||u,children:u?e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"animate-spin"}),e.jsx("span",{children:a.BUSCANDO_CONDUCTOR})]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{}),e.jsx("span",{children:a.SOLICITAR_VIAJE})]})}),d&&l&&e.jsx("p",{className:"mt-2 text-xs text-center text-secondary",children:a.CONDUCTORES_CERCANOS_NOTIFICADOS})]}),B.length>0&&e.jsxs("div",{className:"mt-8",children:[e.jsx("h2",{className:"text-lg font-semibold text-dark mb-4",children:a.VIAJES_DISPONIBLES}),e.jsx("div",{className:"space-y-4",children:B.map(s=>{var t,r,i;return e.jsxs("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-dark",children:s.driverName}),e.jsxs("div",{className:"flex items-center text-warning text-sm",children:[e.jsx(oe,{className:"mr-1"}),e.jsxs("span",{children:[s.rating," (",s.reviewCount," ",a.RESENAS,")"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xl font-bold text-primary",children:["$",(t=s.price)==null?void 0:t.toLocaleString()]}),e.jsx("div",{className:"text-sm text-secondary",children:s.availableSeats>0?`${s.availableSeats} ${s.availableSeats>1?a.ASIENTOS:a.ASIENTO} ${a.DISPONIBLE}`:a.SIN_CUPOS})]})]}),e.jsxs("div",{className:"space-y-2 text-sm mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{className:"text-danger mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(r=s.origin)==null?void 0:r.address})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{className:"text-success mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(i=s.destination)==null?void 0:i.address})]}),e.jsxs("div",{className:"flex items-center text-secondary",children:[e.jsx(me,{className:"mr-2 w-4"}),e.jsx("span",{children:U(s.departureTime)})]}),e.jsxs("div",{className:"flex items-center text-secondary",children:[e.jsx(_,{className:"mr-2 w-4"}),e.jsxs("span",{children:[s.carModel," • ",s.carPlate]})]})]}),e.jsx(N,{onClick:()=>te(s),disabled:!s.availableSeats||u,className:`w-full ${s.availableSeats>0?"bg-success hover:bg-success-dark":"bg-secondary cursor-not-allowed"}`,children:s.availableSeats>0?a.RESERVAR_AHORA:a.SIN_CUPOS_DISPONIBLES})]},s.id)})})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-dark",children:a.MIS_VIAJES}),R.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(_,{className:"mx-auto text-secondary text-4xl mb-2"}),e.jsx("p",{className:"text-secondary",children:a.NO_TIENES_VIAJES_PROGRAMADOS}),e.jsx(N,{onClick:()=>O("search"),className:"mt-2 text-primary hover:underline text-sm",children:a.BUSCAR_VIAJES_DISPONIBLES})]}):e.jsx("div",{className:"space-y-4",children:R.map(s=>{var t,r,i,o,G,$,q;return e.jsxs("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium text-dark",children:[(r=(t=s.origin)==null?void 0:t.address)==null?void 0:r.split(",")[0]," → ",(o=(i=s.destination)==null?void 0:i.address)==null?void 0:o.split(",")[0]]}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.status==="confirmed"?"bg-success text-white":s.status==="cancelled"?"bg-secondary text-white":"bg-warning text-white"}`,children:s.status==="confirmed"?a.CONFIRMADO:s.status==="pending"?a.PENDIENTE:s.status==="cancelled"?a.CANCELADO:s.status})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xl font-bold text-primary",children:["$",(G=s.price)==null?void 0:G.toLocaleString()]}),e.jsx("div",{className:"text-sm text-secondary",children:s.departureTime&&U(s.departureTime)})]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{className:"text-danger mr-2 w-4"}),e.jsx("span",{className:"truncate",children:($=s.origin)==null?void 0:$.address})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{className:"text-success mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(q=s.destination)==null?void 0:q.address})]}),s.driverName&&e.jsxs("div",{className:"flex items-center text-secondary",children:[e.jsx("span",{className:"mr-2",children:a.CONDUCTOR}),e.jsx("span",{children:s.driverName})]})]}),s.status==="pending"&&e.jsx("div",{className:"mt-4 pt-3 border-t",children:e.jsx(N,{onClick:()=>re(s.id),disabled:u,className:"w-full bg-danger text-white py-2 rounded-lg font-medium hover:bg-danger-dark transition-colors",children:u?a.CANCELANDO:a.CANCELAR_RESERVA})})]},s.id)})})]})]}),e.jsx("div",{className:"w-full lg:w-2/3 h-64 lg:h-full",children:e.jsxs(xe,{center:J||[0,0],zoom:J?13:2,style:{height:"100%",width:"100%",minHeight:"400px"},children:[e.jsx(he,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),e.jsx(Ne,{onSelect:Z}),d&&e.jsx(D,{position:[d.lat,d.lng],icon:L,children:e.jsxs(T,{children:[a.ORIGEN_PUNTOS,d.address]})}),l&&e.jsx(D,{position:[l.lat,l.lng],icon:new k.Icon({...L.options,iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",iconRetinaUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png"}),children:e.jsxs(T,{children:[a.DESTINO_PUNTOS,l.address]})}),v&&e.jsx(D,{position:[v.latitude,v.longitude],icon:new k.Icon({...L.options,iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",iconRetinaUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png"}),children:e.jsx(T,{children:e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"font-medium",children:g.driverName})})})})]})})]})}export{Ie as default};
//# sourceMappingURL=Passenger-DGiGEVAu.js.map
