import{u as ne,h as m,j as e,n as E,F as ie,k as y,o as ce,p as de}from"./index-B8SLU8vR.js";import{r as c,M as le,T as oe,c as w,L as U,P as b,u as me}from"./leaflet-BldE4BD4.js";import{h as I,f as S,k as xe,B as he,q as _,o as D,w as T,d as f,u as A,C as z,j}from"./firebase-CR0su15k.js";import{S as t,B as N}from"./Button-Dy4WXtgN.js";import{a as ue}from"./react-DcIcrUde.js";const L=new U.Icon({iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function Ne({onSelect:n}){return me({click(p){n(p.latlng)}}),null}const k=n=>{if(!n)return"";const p={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"};return new Date(n).toLocaleDateString("es-CO",p)};function Se(){const{currentUser:n}=ne(),p=ue(),[d,P]=c.useState(null),[l,M]=c.useState(null),[u,h]=c.useState(!1),[R,H]=c.useState([]),[V,Q]=c.useState([]),[B,W]=c.useState([]),[g,pe]=c.useState(null),[F,x]=c.useState(""),[C,O]=c.useState("search"),[J,K]=c.useState(null),[v,X]=c.useState(null);c.useEffect(()=>{if(g!=null&&g.driverId){const s=I(m,"locations",g.driverId),a=S(s,r=>{r.exists()&&X(r.data().location)});return()=>{a()}}},[g]),c.useEffect(()=>{const s=navigator.geolocation.watchPosition(a=>{const{latitude:r,longitude:i}=a.coords;if(K([r,i]),n){const o=I(m,"locations",n.uid);xe(o,{location:new he(r,i),updatedAt:j()})}},a=>{console.error("Error watching position:",a)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0});return()=>{navigator.geolocation.clearWatch(s)}},[n]);const Y=[{id:"search",name:t.BUSCAR_VIAJE},{id:"my-requests",name:t.MIS_SOLICITUDES},{id:"my-trips",name:t.MIS_VIAJES}],Z=async s=>{try{const a=await ee(s.lat,s.lng);d?l||M({lat:s.lat,lng:s.lng,name:t.DESTINO,address:a||t.UBICACION_SELECCIONADA}):P({lat:s.lat,lng:s.lng,name:t.ORIGEN,address:a||t.UBICACION_SELECCIONADA})}catch(a){console.error("Error getting address:",a),x(t.ERROR_OBTENER_DIRECCION)}},ee=async(s,a)=>{try{return(await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${a}&zoom=18&addressdetails=1`)).json()).display_name||t.UBICACION_SELECCIONADA}catch(r){return console.error("Error getting address:",r),t.UBICACION_SELECCIONADA}},se=async s=>{if(window.confirm(t.CONFIRMAR_CANCELAR_SOLICITUD))try{h(!0);const a=I(m,"rideRequests",s);await A(a,{status:"cancelled",updatedAt:new Date().toISOString()})}catch(a){console.error("Error canceling ride request:",a),x(t.ERROR_CANCELAR_SOLICITUD)}finally{h(!1)}},te=async()=>{if(!d||!l){x(t.SELECCIONAR_ORIGEN_DESTINO);return}if(!n){p("/login",{state:{from:"passenger"}});return}h(!0),x("");try{const s={passengerId:n.uid,passengerName:n.displayName||t.USUARIO,passengerEmail:n.email,origin:{lat:d.lat,lng:d.lng,name:d.name,address:d.address},destination:{lat:l.lat,lng:l.lng,name:l.name,address:l.address},status:"pending",timestamp:Date.now(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};await z(f(m,"rideRequests"),s),P(null),M(null)}catch(s){console.error(t.ERROR_SOLICITAR_VIAJE,s),x(t.ERROR_OCURRIDO_SOLICITAR_VIAJE)}finally{h(!1)}};c.useEffect(()=>{if(!n)return;const s=_(f(m,"trips"),T("status","==","available"),D("departureTime","asc")),a=S(s,r=>{const i=[];r.forEach(o=>{i.push({id:o.id,...o.data()})}),W(i)});return()=>a()},[n]),c.useEffect(()=>{if(!n)return;const s=_(f(m,"rideRequests"),T("passengerId","==",n.uid),D("createdAt","desc")),a=S(s,r=>{const i=[];r.forEach(o=>{i.push({id:o.id,...o.data()})}),Q(i)});return()=>a()},[n]),c.useEffect(()=>{if(!n)return;const s=_(f(m,"bookings"),T("passengerId","==",n.uid),D("createdAt","desc")),a=S(s,r=>{const i=[];r.forEach(o=>{i.push({id:o.id,...o.data()})}),H(i)});return()=>a()},[n]);const ae=async s=>{if(!n){p("/login",{state:{from:"passenger"}});return}h(!0),x("");try{const a={tripId:s.id,passengerId:n.uid,passengerName:n.displayName||t.USUARIO,driverId:s.driverId,driverName:s.driverName,origin:s.origin,destination:s.destination,departureTime:s.departureTime,price:s.price,status:"pending",createdAt:j(),updatedAt:j()};await z(f(m,"bookings"),a),await A(I(m,"trips",s.id),{availableSeats:s.availableSeats-1,updatedAt:j()})}catch(a){console.error(t.ERROR_RESERVAR_VIAJE,a),x(t.ERROR_OCURRIDO_RESERVAR_VIAJE)}finally{h(!1)}},re=async s=>{if(window.confirm(t.CONFIRMAR_CANCELAR_RESERVA)){h(!0),x("");try{await A(I(m,"bookings",s),{status:"cancelled",updatedAt:j()});const a=R.find(r=>r.id===s);a&&a.status==="confirmed"&&await A(I(m,"trips",a.tripId),{availableSeats:increment(1),updatedAt:j()})}catch(a){console.error(t.ERROR_CANCELAR_RESERVA,a),x(t.ERROR_OCURRIDO_CANCELAR_RESERVA)}finally{h(!1)}}};return e.jsxs("div",{className:"min-h-screen bg-light flex flex-col lg:flex-row",children:[e.jsxs("div",{className:"w-full lg:w-1/3 bg-white p-6 overflow-y-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6 text-dark",children:t.SOLICITAR_VIAJE}),e.jsx("div",{className:"flex border-b mb-4",children:Y.map(s=>e.jsx(N,{className:`flex-1 py-2 font-medium ${C===s.id?"text-primary border-b-2 border-primary":"text-secondary"}`,onClick:()=>O(s.id),children:s.name},s.id))}),F&&e.jsx("div",{className:"mb-4 p-3 bg-danger text-white rounded-lg",children:F}),C==="my-requests"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-dark",children:t.MIS_SOLICITUDES_DE_VIAJE}),V.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-secondary mb-4",children:t.NO_TIENES_SOLICITUDES}),e.jsx(N,{onClick:()=>O("search"),className:"text-primary hover:text-primary-dark font-medium",children:t.SOLICITAR_UN_VIAJE_AHORA})]}):e.jsx("div",{className:"space-y-4",children:V.map(s=>{var a,r;return e.jsx("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium text-dark",children:[((a=s.origin)==null?void 0:a.address)||t.ORIGEN," → ",((r=s.destination)==null?void 0:r.address)||t.DESTINO]}),e.jsx("p",{className:"text-sm text-secondary mt-1",children:k(s.createdAt)}),e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.status==="pending"?"bg-warning text-white":s.status==="accepted"?"bg-success text-white":"bg-secondary text-white"}`,children:s.status==="pending"?t.PENDIENTE:s.status==="accepted"?t.ACEPTADO:t.CANCELADO})})]}),s.status==="pending"&&e.jsx(N,{onClick:()=>se(s.id),className:"text-danger hover:text-danger-dark text-sm font-medium",disabled:u,children:u?t.CANCELANDO:t.CANCELAR})]})},s.id)})})]}):C==="search"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 p-4 bg-primary-light rounded-lg",children:[e.jsxs("p",{className:"text-sm text-primary-dark mb-3",children:[e.jsx("span",{className:"font-semibold",children:t.INSTRUCCIONES})," ",t.SELECCIONA_ORIGEN_DESTINO_MAPA]}),e.jsxs("ol",{className:"list-decimal list-inside text-sm space-y-1 text-primary-dark",children:[e.jsx("li",{children:t.SELECCIONA_PUNTO_ORIGEN}),e.jsx("li",{children:t.SELECCIONA_PUNTO_DESTINO}),e.jsx("li",{children:t.CONFIRMA_SOLICITUD_VIAJE})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-dark mb-1",children:t.ORIGEN}),e.jsxs("div",{className:"flex items-center bg-light rounded-lg p-3",children:[e.jsx(E,{className:"text-danger mr-2"}),e.jsx("span",{children:(d==null?void 0:d.address)||t.SELECCIONA_EN_MAPA})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-dark mb-1",children:t.DESTINO}),e.jsxs("div",{className:"flex items-center bg-light rounded-lg p-3",children:[e.jsx(E,{className:"text-success mr-2"}),e.jsx("span",{children:(l==null?void 0:l.address)||t.SELECCIONA_EN_MAPA})]})]}),e.jsx(N,{onClick:te,disabled:!d||!l||u,children:u?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"animate-spin"}),e.jsx("span",{children:t.BUSCANDO_CONDUCTOR})]}):e.jsxs(e.Fragment,{children:[e.jsx(y,{}),e.jsx("span",{children:t.SOLICITAR_VIAJE})]})}),d&&l&&e.jsx("p",{className:"mt-2 text-xs text-center text-secondary",children:t.CONDUCTORES_CERCANOS_NOTIFICADOS})]}),B.length>0&&e.jsxs("div",{className:"mt-8",children:[e.jsx("h2",{className:"text-lg font-semibold text-dark mb-4",children:t.VIAJES_DISPONIBLES}),e.jsx("div",{className:"space-y-4",children:B.map(s=>{var a,r,i;return e.jsxs("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-dark",children:s.driverName}),e.jsxs("div",{className:"flex items-center text-warning text-sm",children:[e.jsx(ce,{className:"mr-1"}),e.jsxs("span",{children:[s.rating," (",s.reviewCount," ",t.RESENAS,")"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xl font-bold text-primary",children:["$",(a=s.price)==null?void 0:a.toLocaleString()]}),e.jsx("div",{className:"text-sm text-secondary",children:s.availableSeats>0?`${s.availableSeats} ${s.availableSeats>1?t.ASIENTOS:t.ASIENTO} ${t.DISPONIBLE}`:t.SIN_CUPOS})]})]}),e.jsxs("div",{className:"space-y-2 text-sm mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(E,{className:"text-danger mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(r=s.origin)==null?void 0:r.address})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(E,{className:"text-success mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(i=s.destination)==null?void 0:i.address})]}),e.jsxs("div",{className:"flex items-center text-secondary",children:[e.jsx(de,{className:"mr-2 w-4"}),e.jsx("span",{children:k(s.departureTime)})]}),e.jsxs("div",{className:"flex items-center text-secondary",children:[e.jsx(y,{className:"mr-2 w-4"}),e.jsxs("span",{children:[s.carModel," • ",s.carPlate]})]})]}),e.jsx(N,{onClick:()=>ae(s),disabled:!s.availableSeats||u,className:`w-full ${s.availableSeats>0?"bg-success hover:bg-success-dark":"bg-secondary cursor-not-allowed"}`,children:s.availableSeats>0?t.RESERVAR_AHORA:t.SIN_CUPOS_DISPONIBLES})]},s.id)})})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-dark",children:t.MIS_VIAJES}),R.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(y,{className:"mx-auto text-secondary text-4xl mb-2"}),e.jsx("p",{className:"text-secondary",children:t.NO_TIENES_VIAJES_PROGRAMADOS}),e.jsx(N,{onClick:()=>O("search"),className:"mt-2 text-primary hover:underline text-sm",children:t.BUSCAR_VIAJES_DISPONIBLES})]}):e.jsx("div",{className:"space-y-4",children:R.map(s=>{var a,r,i,o,$,G,q;return e.jsxs("div",{className:"border rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium text-dark",children:[(r=(a=s.origin)==null?void 0:a.address)==null?void 0:r.split(",")[0]," → ",(o=(i=s.destination)==null?void 0:i.address)==null?void 0:o.split(",")[0]]}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.status==="confirmed"?"bg-success text-white":s.status==="cancelled"?"bg-secondary text-white":"bg-warning text-white"}`,children:s.status==="confirmed"?t.CONFIRMADO:s.status==="pending"?t.PENDIENTE:s.status==="cancelled"?t.CANCELADO:s.status})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-xl font-bold text-primary",children:["$",($=s.price)==null?void 0:$.toLocaleString()]}),e.jsx("div",{className:"text-sm text-secondary",children:s.departureTime&&k(s.departureTime)})]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(E,{className:"text-danger mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(G=s.origin)==null?void 0:G.address})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(E,{className:"text-success mr-2 w-4"}),e.jsx("span",{className:"truncate",children:(q=s.destination)==null?void 0:q.address})]}),s.driverName&&e.jsxs("div",{className:"flex items-center text-secondary",children:[e.jsx("span",{className:"mr-2",children:t.CONDUCTOR}),e.jsx("span",{children:s.driverName})]})]}),s.status==="pending"&&e.jsx("div",{className:"mt-4 pt-3 border-t",children:e.jsx(N,{onClick:()=>re(s.id),disabled:u,className:"w-full bg-danger text-white py-2 rounded-lg font-medium hover:bg-danger-dark transition-colors",children:u?t.CANCELANDO:t.CANCELAR_RESERVA})})]},s.id)})})]})]}),e.jsx("div",{className:"w-full lg:w-2/3 h-64 lg:h-full",children:e.jsxs(le,{center:J||[0,0],zoom:J?13:2,style:{height:"100%",width:"100%",minHeight:"400px"},children:[e.jsx(oe,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),e.jsx(Ne,{onSelect:Z}),d&&e.jsx(w,{position:[d.lat,d.lng],icon:L,children:e.jsxs(b,{children:[t.ORIGEN_PUNTOS,d.address]})}),l&&e.jsx(w,{position:[l.lat,l.lng],icon:new U.Icon({...L.options,iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",iconRetinaUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png"}),children:e.jsxs(b,{children:[t.DESTINO_PUNTOS,l.address]})}),v&&e.jsx(w,{position:[v.latitude,v.longitude],icon:new U.Icon({...L.options,iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",iconRetinaUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png"}),children:e.jsx(b,{children:e.jsx("div",{className:"space-y-1",children:e.jsx("p",{className:"font-medium",children:g.driverName})})})})]})})]})}export{Se as default};
//# sourceMappingURL=Passenger-Dkyyt3Jz.js.map
