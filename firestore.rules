rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isRole(role) {
      return isAuthenticated() && getUserRole(request.auth.uid) == role;
    }
    
    function isDriver() {
      return isRole('driver');
    }
    
    function isAdmin() {
      return isRole('admin');
    }

    // Users collection rules
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
    }

    // Trips collection rules
    match /trips/{tripId} {
      // Allow read if authenticated and you're the driver, passenger, or an admin
      allow get: if isAuthenticated() && 
                (request.auth.uid == resource.data.driverId || 
                 request.auth.uid == resource.data.passengerId ||
                 isRole('admin'));
      
      // Allow list if authenticated and querying by driverId or passengerId, or if admin
      allow list: if isAuthenticated();
      
      // Allow create if authenticated and the trip is properly formed
      allow create: if isAuthenticated() && 
                   (request.resource.data.driverId == request.auth.uid || 
                    request.resource.data.passengerId == request.auth.uid) &&
                   request.resource.data.status in ['pending', 'searching', 'accepted'] &&
                   request.resource.data.origin is map &&
                   request.resource.data.destination is map;
      
      // Allow updates to status by driver or passenger, or admin
      allow update: if isAuthenticated() && (
        // Driver can update trip status and location
        (request.auth.uid == resource.data.driverId &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'driverLocation', 'updatedAt'])) ||
        
        // Passenger can rate the trip
        (request.auth.uid == resource.data.passengerId &&
         (resource.data.status == 'completed' || resource.data.status == 'cancelled') &&
         (!resource.data.rating || resource.data.rating == 0) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating', 'comment', 'ratedAt', 'status', 'updatedAt']) &&
         request.resource.data.rating >= 1 &&
         request.resource.data.rating <= 5 &&
         (request.resource.data.status == 'completed' || request.resource.data.status == 'cancelled')) ||
         
        // Admin can update anything
        isRole('admin')
      );
      
      // Allow delete only by the driver or admin
      allow delete: if isAuthenticated() && 
                   (isOwner(resource.data.driverId) || isRole('admin'));
    }
    
    // Bookings collection rules
    match /bookings/{bookingId} {
      // Allow read if you're the driver, passenger, or an admin
      allow read: if isAuthenticated() && 
                 (request.auth.uid == resource.data.driverId || 
                  request.auth.uid == resource.data.passengerId ||
                  isRole('admin'));
      
      // Allow create if authenticated and the passenger is the one creating it
      allow create: if isAuthenticated() && request.resource.data.passengerId == request.auth.uid;
      
      // Allow update if you're the driver or passenger of the trip
      allow update: if isAuthenticated() && (
        // Driver can update booking status
        (request.auth.uid == resource.data.driverId &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt'])) ||
        
        // Passenger can update their booking
        (request.auth.uid == resource.data.passengerId &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'rating', 'comment', 'ratedAt', 'updatedAt']) &&
         (!resource.data.rating || resource.data.rating == 0) &&
         (resource.data.status == 'completed' || resource.data.status == 'cancelled')) ||
         
        // Admin can update anything
        isRole('admin')
      );
    }
    
    // Ratings collection rules
    match /ratings/{ratingId} {
      // Allow read for authenticated users
      allow read: if isAuthenticated();
      
      // Allow create if authenticated and the rater is the one creating it
      allow create: if isAuthenticated() && request.resource.data.raterId == request.auth.uid;
      
      // No updates or deletes after creation
      allow update, delete: if false;
    }

    // Locations collection rules
    match /locations/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Ride Requests collection rules
    match /rideRequests/{requestId} {
      // Allow read if:
      // 1. User is authenticated
      // 2. AND (user is the passenger OR user is a driver OR user is admin)
      allow read: if isAuthenticated() && 
                 (request.auth.uid == resource.data.passengerId ||
                  isDriver() || 
                  isAdmin());
                  
      // Allow drivers to list ride requests with status 'pending'
      allow list: if isAuthenticated() && 
                 (isDriver() || isAdmin()) &&
                 request.query.limit != null &&
                 request.query.where['status'] == 'pending';
      
      // Allow create if:
      // 1. User is authenticated
      // 2. AND user is the passenger creating the request
      allow create: if isAuthenticated() && 
                   request.resource.data.passengerId == request.auth.uid &&
                   request.resource.data.status == 'pending';
      
      // Allow update if:
      // 1. User is authenticated
      // 2. AND (user is the passenger OR user is a driver OR user is admin)
      // 3. AND only specific fields can be updated
      allow update: if isAuthenticated() && 
                   (request.auth.uid == resource.data.passengerId || 
                    isDriver() || 
                    isAdmin()) &&
                   (request.resource.data.diff(resource.data).affectedKeys()
                    .hasOnly(['status', 'driverId', 'driverName', 'updatedAt', 'tripId', 'driverPhotoURL', 'acceptedAt']));
      
      // Allow delete if:
      // 1. User is authenticated
      // 2. AND (user is the passenger OR user is admin)
      allow delete: if isAuthenticated() && 
                   (request.auth.uid == resource.data.passengerId || 
                    isAdmin());
    }

    // System collection (for app configuration, etc.)
    match /_system/{document=**} {
      // Only admins can read/write system settings
      allow read, write: if isAdmin();
    }

    // Chat collection rules
    match /chats/{tripId} {
      // Allow read on the chat document itself if you are a participant
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participant_uids;

      // When creating the chat document, any participant can do it.
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participant_uids;

      match /messages/{messageId} {
        // A user is a participant if they are the driver or passenger of the trip.
        // This function safely checks if the trip document exists before reading it.
        function isTripParticipant() {
          let tripDocPath = /databases/$(database)/documents/trips/$(tripId);
          let tripExists = exists(tripDocPath);
          let tripData = tripExists ? get(tripDocPath).data : {};

          let isDriver = tripExists && 'driverId' in tripData && tripData.driverId == request.auth.uid;
          let isPassenger = tripExists && 'passengerId' in tripData && tripData.passengerId == request.auth.uid;

          return isDriver || isPassenger;
        }

        // Allow trip participants to read messages
        allow read: if isAuthenticated() && isTripParticipant();

        // Allow trip participants to create messages, validating the senderId
        allow create: if isAuthenticated() &&
                       isTripParticipant() &&
                       request.resource.data.senderId == request.auth.uid;

        // Do not allow updates or deletes to keep chat history immutable
        allow update, delete: if false;
      }
    }
  }
}