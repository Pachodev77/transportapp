rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isRole(role) {
      return isAuthenticated() && getUserRole(request.auth.uid) == role;
    }
    
    function isDriver() {
      return isRole('driver');
    }
    
    function isAdmin() {
      return isRole('admin');
    }

    // Users collection rules
    match /users/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isRole('admin'));
      
      allow update: if isAuthenticated() && (
        isOwner(userId) || 
        isRole('admin') ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['fcmToken', 'updatedAt'])) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['completedTrips', 'updatedAt']) &&
         request.resource.data.completedTrips == resource.data.completedTrips + 1) ||
        // Allow rating updates only via transaction
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating', 'ratingCount', 'updatedAt']) &&
         request.auth.token.firebase.sign_in_provider == 'custom')
      );
      
      allow create: if isAuthenticated();
      
      allow delete: if isRole('admin');
      
      match /tripHistory/{tripId} {
        allow read, write: if isAuthenticated() && (isOwner(userId) || isAdmin());
      }
    }
    
    // Bookings collection rules
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && 
                 (request.auth.uid == resource.data.driverId || 
                  request.auth.uid == resource.data.passengerId ||
                  isRole('admin'));
      
      allow create: if isAuthenticated() && request.resource.data.passengerId == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        (request.auth.uid == resource.data.driverId &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt'])) ||
        (request.auth.uid == resource.data.passengerId &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt'])) ||
        isRole('admin')
      );
    }

    // Locations collection rules
    match /locations/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Ride Requests collection rules
    match /rideRequests/{requestId} {
      allow read: if isAuthenticated() && 
                 (request.auth.uid == resource.data.passengerId ||
                  isDriver() || 
                  isAdmin());
                  
      allow list: if isAuthenticated() && 
                 (isDriver() && request.query.where.status == 'pending' || isAdmin());
      
      allow create: if isAuthenticated() && 
                   request.resource.data.passengerId == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        (request.auth.uid == resource.data.passengerId &&
         resource.data.status == 'completed' &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating', 'comment', 'ratedAt', 'updatedAt', 'canRate', 'ratedBy'])) ||
        (request.auth.uid == resource.data.passengerId &&
         request.resource.data.status == 'pending' &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'cancelledAt', 'updatedAt', 'cancelledBy'])) ||
        (isDriver() && (
          (resource.data.status == 'pending' && 
           request.resource.data.status == 'accepted' &&
           request.resource.data.driverId == request.auth.uid &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'driverId', 'driverName', 'updatedAt', 'driverPhotoURL', 'acceptedAt'])) ||
          (resource.data.status == 'accepted' &&
           request.resource.data.status in ['in_progress', 'completed'] &&
           request.resource.data.driverId == request.auth.uid &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt', 'completedAt', 'canRate']))
        )) ||
        isAdmin()
      );
      
      allow delete: if isAuthenticated() && 
                   (request.auth.uid == resource.data.passengerId || 
                    isAdmin());
    }
    
    match /chats/{tripId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participant_uids;

      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participant_uids;

      match /messages/{messageId} {
        function isTripParticipant() {
          let rideRequestDocPath = /databases/$(database)/documents/rideRequests/$(tripId);
          let rideRequestExists = exists(rideRequestDocPath);
          let rideRequestData = rideRequestExists ? get(rideRequestDocPath).data : {};

          let isDriver = rideRequestExists && 'driverId' in rideRequestData && rideRequestData.driverId == request.auth.uid;
          let isPassenger = rideRequestExists && 'passengerId' in rideRequestData && rideRequestData.passengerId == request.auth.uid;

          return isDriver || isPassenger;
        }

        allow read: if isAuthenticated() && isTripParticipant();

        allow create: if isAuthenticated() &&
                       isTripParticipant() &&
                       request.resource.data.senderId == request.auth.uid;

        allow update, delete: if false;
      }
    }
  }
}